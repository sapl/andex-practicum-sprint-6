# Задание 3. Переход на Event-Driven архитектуру


## Обновленная схема

**[Event-Driven архитектура](https://viewer.diagrams.net/?lightbox=1&highlight=0000ff&nav=1&title=InsureTech_C4_%D1%81ontainer-diagram#Uhttps%3A%2F%2Fdrive.google.com%2Fuc%3Fid%3D1adD5VAS4twn0U_1DFipJedGGhobReyVO%26export%3Ddownload)**

## Проблемы и риски текущей архитектуры

- `ins-product-aggregator` в одном синхронном запросе API делает 5 а потом 10 синхронных
запросов к внешним API страховых компаний.
- Те суммарное время на запрос от `core-app` и `ins-comp-settlement` будет увеличиваться
что будет приводить к ошибкам по таймауту
- Не понятно что вернет API если отвалился запрос к одной из 10 компаний
или потеряются данные для нее до следующего запуска через 15 минут или отвалится весь запроси.
И то и то приводит к нестабильности и ошибкам.
- Сложно настроить ретраи, circuit breakers и другие механизмы обработки ошибок для каждого API.
- Сервис `core-app` и `ins-comp-settlement` зависят от доступности `ins-product-aggregator` для обновления данных.
если он будет недоступен например на момент отчета то может отвалиться весь месячный отчет.
- Высокая нагрузка на `ins-product-aggregator` при большом количестве параллельных запросов.
- Отставание данных о продуктах и тарифах от реального времени из-за периодичности обновлений/сбоев.

## Предложенное решение

#### Переход на Event-Driven архитектуру

- Использовать Kafka для полписки на обновления данных о продуктах и тарифах.
- `ins-product-aggregator` публикует события с обновлёнными данными продуктов в топик.
- `core-app` и `ins-comp-settlement` подписываются на соответствующий топик и обновляют свои локальные реплики данных.
- По возможности подписаться на Webhook от партренов для обновления данных в реальном времени.
  Локальные реплики в сервисах `core-app` и `ins-comp-settlement` будут обновляться в реальном времени, как только
  поступают новые события из топика.
- Добавление новых страховых компаний больше не увеличивает нагрузку на `ins-product-aggregator`, так как взаимодействие
  между сервисами становится асинхронным. Если запросы на обновление данных из внешних API будут скапливаться в очереди можно увеличить число консумеров/реплик
При этом пики будут сглаживаться очередью.

#### Применение Transactional Outbox 

Наверное пока не требуется. Так как обновление данных о продуктах и тарифах не должно быть транзакционным.
Обновление происходит идемпотентно и не должно приводить к ошибкам в случае повторного обновления.
Сервис `ins-comp-settlement` при генерации отчета продолжит обращаться к `core-app` синхронно через REST API.
Так как это происходит редко, поэтому неконсистентности данных не должно возникнуть.

### Примеры топиков и событий

- Cервис `ins-product-aggregator` публикует обновления о продуктах и тарифах страховых компаний.
обновления могут по прежнему запускаться по крону или по запросу.  
  **События в топике `product-updates`:** 
  - `ProductUpdated` — обновление данных о продуктах.
  - `TariffUpdated` — обновление тарифов.
  **Подписчики:**
  - core-app — обновляет локальную реплику данных о продуктах.
  - ins-comp-settlement — обновляет данные о тарифах для расчета агентских премий.
  

- Сервис `core-app`   публикует события, связанные с оформлением страховок.   
  **События в топике `insurance-policies`:**
  - InsurancePolicyCreated — создание новой страховки.
  - InsurancePolicyUpdated — изменение данных страховки.
  **Подписчики:**
  - ins-comp-settlement 
  - Потенциально другие сервисы (например, аналитика, уведомления).
 
